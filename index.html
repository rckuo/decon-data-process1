<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Bioproduction Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    :root {
      --bg:#fff; --fg:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563eb; --primary-fg:#fff; --card:#f8fafc;
    }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           color:var(--fg); background:var(--bg); margin:24px; }
    h2 { margin:0 0 10px 0; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="number"] {
      padding:10px 12px; border:1px solid var(--line); border-radius:10px; min-width:420px;
    }
    input[type="number"] { max-width:140px; }
    button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer;
             box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    button.primary { background:var(--primary); color:var(--primary-fg); }
    button.secondary { background:#eef2ff; color:#1e293b; }
    .panel { margin-top:16px; padding:16px; border:1px solid var(--line); border-radius:12px; background:var(--bg); }
    .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
              gap:12px; margin-top:12px; }
    .card { border:1px solid var(--line); border-radius:12px; overflow:hidden; background:var(--card); }
    .card-header { padding:8px 10px; font-size:0.9rem; color:var(--muted); border-bottom:1px solid var(--line); }
    .card img { display:block; width:100%; height:auto; }
    .muted { color:var(--muted); font-size:0.95rem; }
    .error { color:#b91c1c; }
    .spacer { height:6px; }
    .seg { display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden; }
    .seg button { background:#f1f5f9; color:#0f172a; }
    .seg .active { background:#111827; color:#fff; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h2>Data Analysis for Co-Products</h2>

  <div class="row">
    <button class="primary" onclick="login()">Sign in with Google</button>
    <span class="muted">Each user must sign in once on their own device.</span>
  </div>

  <div class="panel">
    <div class="row" style="margin-bottom:8px;">
      <div class="seg">
        <button id="btnModeProd" class="active" onclick="setMode('production')">Production</button>
        <button id="btnModeGrowth" onclick="setMode('growth')">Growth Curves</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:10px;">
      <input type="text" id="sheet_id" placeholder="Paste Google Sheet URL or ID (HPLC & II for Production; OD/OD600/Growth for Growth Curves)"/>
      <input type="number" id="timepoint" placeholder="Timepoint (e.g., 24)" min="0" step="1"/>
      <button class="secondary" onclick="analyze()">Analyze & Preview</button>
    </div>

    <!-- Download buttons (separate per mode) -->
    <div class="row" style="margin-bottom:6px;">
      <div id="dlProduction">
        <button class="secondary" onclick="startJob('pdf')">⬇️ Download Production PDF (queued)</button>
        <button class="secondary" onclick="startJob('zip')">⬇️ Download Production PNGs (ZIP, queued)</button>
      </div>
      <div id="dlGrowth" class="hidden">
        <button class="secondary" onclick="startJobGrowth('pdf')">⬇️ Download Growth PDF (queued)</button>
        <button class="secondary" onclick="startJobGrowth('zip')">⬇️ Download Growth PNGs (ZIP, queued)</button>
      </div>
      <span id="queueStatus" class="muted"></span>
    </div>

    <div id="status" class="muted"></div>
    <div class="spacer"></div>

    <div id="preview" class="thumbs"></div>
  </div>

  <script>
    const API_BASE = "https://decon-data-backend.onrender.com";
    let mode = "production";

    function setMode(m) {
      mode = m;
      document.getElementById("btnModeProd").classList.toggle("active", mode==="production");
      document.getElementById("btnModeGrowth").classList.toggle("active", mode==="growth");
      document.getElementById("timepoint").classList.toggle("hidden", mode==="growth");
      document.getElementById("dlProduction").classList.toggle("hidden", mode!=="production");
      document.getElementById("dlGrowth").classList.toggle("hidden", mode!=="growth");
      setStatus(""); setQueue(""); document.getElementById("preview").innerHTML="";
    }

    function setStatus(msg, isError=false) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.className = isError ? "error" : "muted";
    }
    function setQueue(msg) { document.getElementById("queueStatus").textContent = msg || ""; }
    function extractId(urlOrId) { const m = String(urlOrId || "").match(/[-\w]{25,}/); return m ? m[0] : urlOrId; }

    async function login() {
      setStatus("Redirecting to Google sign-in…");
      const res = await fetch(`${API_BASE}/api/login`, { credentials: 'include' });
      const data = await res.json();
      window.location = data.auth_url;
    }

    function requireInputs() {
      const sheetInput = document.getElementById("sheet_id").value.trim();
      if (!sheetInput) { setStatus("Please paste a Google Sheet URL or ID.", true); return null; }
      const sheet_id = extractId(sheetInput);
      if (mode === "production") {
        const tp = document.getElementById("timepoint").value.trim();
        if (tp === "") { setStatus("Please enter a timepoint for production.", true); return null; }
        const timepoint = parseInt(tp, 10);
        if (Number.isNaN(timepoint)) { setStatus("Timepoint must be a valid integer.", true); return null; }
        return { sheet_id, timepoint };
      }
      return { sheet_id };
    }

    async function analyze() {
      setQueue("");
      const inp = requireInputs();
      if (!inp) return;

      const payload = { sheet_id: inp.sheet_id, mode };
      if (mode === "production") payload.timepoint = inp.timepoint;

      setStatus("Analyzing… generating plots…");
      const res = await fetch(`${API_BASE}/api/analyze`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });

      if (res.status === 401) { setStatus("Please click “Sign in with Google” first.", true); return; }

      let data;
      try { data = await res.json(); } catch { setStatus("Server returned invalid JSON.", true); return; }
      if (!res.ok || data.error) { setStatus(data.error || `Error ${res.status}`, true); return; }

      renderPreviews(data.images || []);
      const msg = mode==="production"
        ? `Done. Generated ${data.image_count || 0} plot(s) for timepoint ${data.timepoint}.`
        : `Done. Generated ${data.image_count || 0} growth plot(s).`;
      setStatus(msg);
    }

    function renderPreviews(images) {
      const box = document.getElementById("preview");
      box.innerHTML = "";
      if (!images.length) {
        box.innerHTML = `<div class="muted">No plots produced. Check your sheet columns.</div>`;
        return;
      }
      for (const img of images) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">${img.title || img.filename}</div>
          <img src="${img.data_url}" alt="${img.title || img.filename}" />
        `;
        box.appendChild(card);
      }
    }

    // Production queued downloads
    async function startJob(fmt) {
      if (mode !== "production") { setStatus("Switch to Production to use these buttons.", true); return; }
      const inp = requireInputs(); if (!inp) return;
      setQueue("Submitting job…"); setStatus("");
      const res = await fetch(`${API_BASE}/api/job`, {
        method: "POST", credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sheet_id: inp.sheet_id, mode: "production", timepoint: inp.timepoint, format: fmt })
      });
      if (res.status === 401) { setQueue(""); setStatus("Please sign in first.", true); return; }
      const data = await res.json();
      if (!res.ok || data.error) { setQueue(""); setStatus(data.error || `Error ${res.status}`, true); return; }
      pollJob(data.job_id);
    }

    // Growth queued downloads
    async function startJobGrowth(fmt) {
      if (mode !== "growth") { setStatus("Switch to Growth to use these buttons.", true); return; }
      const inp = requireInputs(); if (!inp) return;
      setQueue("Submitting job…"); setStatus("");
      const res = await fetch(`${API_BASE}/api/job`, {
        method: "POST", credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sheet_id: inp.sheet_id, mode: "growth", format: fmt })
      });
      if (res.status === 401) { setQueue(""); setStatus("Please sign in first.", true); return; }
      const data = await res.json();
      if (!res.ok || data.error) { setQueue(""); setStatus(data.error || `Error ${res.status}`, true); return; }
      pollJob(data.job_id);
    }

    async function pollJob(jobId) {
      setQueue("Running…");
      const poll = setInterval(async () => {
        const res = await fetch(`${API_BASE}/api/job/${jobId}/status`, { credentials: "include" });
        let st;
        try { st = await res.json(); } catch { setQueue(""); setStatus("Polling failed.", true); clearInterval(poll); return; }
        if (st.status === "done") {
          clearInterval(poll); setQueue("");
          window.location = `${API_BASE}/api/job/${jobId}/download`;
        } else if (st.status === "error") {
          clearInterval(poll); setQueue(""); setStatus(`Job failed: ${st.error}`, true);
        }
      }, 1500);
    }

    // default UI state
    setMode('production');
  </script>
</body>
</html>
